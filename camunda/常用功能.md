### å…¨å±€ç›‘å¬å™¨ç¬”è®° ğŸŒ

#### 1. ä»»åŠ¡ç›‘å¬å™¨ï¼šè®°å½•ä»»åŠ¡æäº¤äºº (SubmittingUserListener) ğŸ“

- **ç›®çš„**ï¼šåœ¨Camundaæµç¨‹ä¸­è‡ªåŠ¨è®°å½•æ¯ä¸ªä»»åŠ¡çš„æäº¤äººã€‚
- **å…³é”®å®ç° ï¼š**
  - ğŸ” æ£€æŸ¥å½“å‰æµç¨‹å®ä¾‹ä¸­å‰©ä½™çš„ä»»åŠ¡æ•°é‡ã€‚
  - âœ… è‹¥åªå‰©ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œåˆ™è®¤å®šè¯¥ä»»åŠ¡çš„æ‰§è¡Œè€…ä¸ºæ•´ä¸ªæµç¨‹çš„æäº¤äººã€‚

```java
package com.zq.digitalLab.camunda.listener;

import com.zq.digitalLab.camunda.constant.ProcessConstant;
import org.camunda.bpm.engine.delegate.DelegateTask;
import org.camunda.bpm.engine.delegate.TaskListener;
import org.camunda.bpm.engine.task.Task;

import java.util.List;

/**
 * è®°å½•ä»»åŠ¡æäº¤äººç›‘å¬å™¨
 * @author xieq
 * @date 2023/11/13 10:31
 */
public class SubmittingUserListener implements TaskListener {
    @Override
    public void notify(DelegateTask delegateTask) {
        // è·å–å½“å‰æµç¨‹å®ä¾‹ä¸­çš„æ‰€æœ‰ä»»åŠ¡
        List<Task> list = delegateTask
                .getExecution()
                .getProcessEngineServices()
                .getTaskService()
                .createTaskQuery()
                .processInstanceId(delegateTask.getProcessInstanceId())
                .list();

        // å¦‚æœä»»åŠ¡åˆ—è¡¨åªå‰©ä¸€ä¸ªï¼Œè®¤ä¸ºè¯¥æ‰§è¡Œè€…ä¸ºæäº¤äºº
        if (list.size() == 1) {
            String assignee = delegateTask.getAssignee();
            // å°†æ‰§è¡Œè€…è®¾ç½®ä¸ºæäº¤äºº
            delegateTask.setVariable(ProcessConstant.SUBMIT_USER, assignee);
        }
    }
}

```

#### 2. è§£æç›‘å¬å™¨ï¼šå…¨å±€BPMNç›‘å¬ (GlobalUserTaskListener) ğŸ”

- **ç›®çš„**ï¼šåœ¨è§£æBPMNæ–‡ä»¶æ—¶ï¼Œä¸ºæ¯ä¸ªç”¨æˆ·ä»»åŠ¡è‡ªåŠ¨æ³¨å…¥ `SubmittingUserListener`ã€‚
- **å…³é”®å®ç°**ï¼š
  - ğŸ› ï¸ å½“è§£æ `userTask` å…ƒç´ æ—¶ï¼Œå°† `SubmittingUserListener` æ·»åŠ åˆ°ä»»åŠ¡å®Œæˆäº‹ä»¶ä¸­ã€‚

```java
package com.zq.digitalLab.camunda.listener;

import lombok.extern.slf4j.Slf4j;
import org.camunda.bpm.engine.delegate.TaskListener;
import org.camunda.bpm.engine.impl.bpmn.behavior.UserTaskActivityBehavior;
import org.camunda.bpm.engine.impl.bpmn.parser.AbstractBpmnParseListener;
import org.camunda.bpm.engine.impl.pvm.process.ActivityImpl;
import org.camunda.bpm.engine.impl.pvm.process.ScopeImpl;
import org.camunda.bpm.engine.impl.task.TaskDefinition;
import org.camunda.bpm.engine.impl.util.xml.Element;

/**
 * å…¨å±€ç”¨æˆ·ä»»åŠ¡ç›‘å¬å™¨
 * @author xieq
 * @date 2023/11/13 10:36
 */
@Slf4j
public class GlobalUserTaskListener extends AbstractBpmnParseListener {

    @Override
    public void parseUserTask(Element userTaskElement, ScopeImpl scope, ActivityImpl activity) {
        try {
            // è·å–ä»»åŠ¡å®šä¹‰å¹¶æ·»åŠ æäº¤äººç›‘å¬å™¨
            TaskDefinition taskDefinition = ((UserTaskActivityBehavior) activity.getActivityBehavior()).getTaskDefinition();
            taskDefinition.addTaskListener(TaskListener.EVENTNAME_COMPLETE, new SubmittingUserListener());
        } catch (Exception e) {
            log.error("æ·»åŠ æäº¤äººç›‘å¬å™¨å¤±è´¥: ", e);
            throw new RuntimeException("è®¾ç½®æäº¤äººå¤±è´¥");
        }
    }
}

```

#### 3. é…ç½®ç±»ï¼šCamundaæµç¨‹å¼•æ“é›†æˆ (CamundaConfig) âš™ï¸

- **ç›®çš„**ï¼šé€šè¿‡è‡ªå®šä¹‰çš„æµç¨‹å¼•æ“æ’ä»¶ï¼Œå°† `GlobalUserTaskListener` é›†æˆåˆ°Camundaæµç¨‹å¼•æ“ã€‚
- **å…³é”®å®ç°**ï¼š
  - ğŸ“Œ åœ¨å¼•æ“çš„é¢„åˆå§‹åŒ–é˜¶æ®µï¼Œæ£€æŸ¥å¹¶æ›´æ–°BPMNè§£æç›‘å¬å™¨åˆ—è¡¨ã€‚
  - â• æ·»åŠ  `GlobalUserTaskListener` åˆ°é¢„è§£æç›‘å¬å™¨åˆ—è¡¨ã€‚

```java
package com.zq.digitalLab.camunda.config;

import com.zq.digitalLab.camunda.listener.GlobalUserTaskListener;
import org.camunda.bpm.engine.impl.bpmn.parser.BpmnParseListener;
import org.camunda.bpm.engine.impl.cfg.AbstractProcessEnginePlugin;
import org.camunda.bpm.engine.impl.cfg.ProcessEngineConfigurationImpl;
import org.camunda.bpm.engine.impl.cfg.ProcessEnginePlugin;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.ArrayList;
import java.util.List;

/**
 * Camundaé…ç½®ç±»
 * @author xieq
 * @date 2023/11/13 10:38
 */
@Configuration
public class CamundaConfig {

    @Bean
    public ProcessEnginePlugin myCustomListenersPlugin() {
        return new AbstractProcessEnginePlugin() {
            @Override
            public void preInit(ProcessEngineConfigurationImpl processEngineConfiguration) {
                // è·å–æˆ–åˆ›å»ºBPMNè§£æç›‘å¬å™¨åˆ—è¡¨
                List<BpmnParseListener> preParseListeners = processEngineConfiguration.getCustomPreBPMNParseListeners();
                if (preParseListeners == null) {
                    preParseListeners = new ArrayList<>();
                    processEngineConfiguration.setCustomPreBPMNParseListeners(preParseListeners);
                }
                // æ·»åŠ å…¨å±€ç”¨æˆ·ä»»åŠ¡ç›‘å¬å™¨
                preParseListeners.add(new GlobalUserTaskListener());
            }
        };
    }
}
```

### æ€»ç»“ ğŸŒŸ

- è¿™ç»„ä»£ç ç¬”è®°æ¶‰åŠäº† Camunda BPM å·¥ä½œæµä¸­ä¸‰ä¸ªå…³é”®çš„ç›‘å¬å™¨ï¼šç”¨äºè®°å½•æäº¤äººçš„ä»»åŠ¡ç›‘å¬å™¨ï¼Œå…¨å±€BPMNæ–‡ä»¶è§£æç›‘å¬å™¨ï¼Œä»¥åŠæµç¨‹å¼•æ“é…ç½®ç±»ã€‚
- ğŸ¯ æ ¸å¿ƒç›®æ ‡æ˜¯è‡ªåŠ¨åŒ–ä»»åŠ¡æäº¤äººçš„è®°å½•ï¼ŒåŒæ—¶ç¡®ä¿å…¨å±€èŒƒå›´å†…çš„ä¸€è‡´æ€§å’Œé«˜æ•ˆæ€§ã€‚
- ğŸ”„ é€šè¿‡è¿™äº›è‡ªå®šä¹‰ç›‘å¬å™¨å’Œé…ç½®ï¼Œå¯ä»¥æœ‰æ•ˆåœ°ç®€åŒ–æµç¨‹ç®¡ç†ï¼Œå¹¶å¢å¼ºå·¥ä½œæµçš„é€æ˜åº¦å’Œè¿½è¸ªèƒ½åŠ›ã€‚